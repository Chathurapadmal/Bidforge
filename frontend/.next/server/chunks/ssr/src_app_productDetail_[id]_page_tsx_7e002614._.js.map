{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 5, "column": 0}, "map": {"version":3,"sources":["file:///E:/New%20folder/Bidforge/frontend/src/app/productDetail/%5Bid%5D/page.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport { useParams, useRouter } from \"next/navigation\";\r\nimport { apiFetch } from \"../../../lib/api\";\r\nimport { toImageSrc } from \"../../../lib/Config\";\r\nimport { useSession } from \"../../../lib/session\";\r\n\r\ntype StatusResp = {\r\n  currentBid: number;\r\n  topBid: {\r\n    amount: number;\r\n    bidderId: string;\r\n    bidderName?: string | null;\r\n  } | null;\r\n  isEnded: boolean;\r\n  canPurchase: boolean;\r\n  purchasedAt?: string | null;\r\n};\r\n\r\ntype DetailResp = {\r\n  id: number;\r\n  title: string;\r\n  description?: string | null;\r\n  currentBid: number;\r\n  startTime: string;\r\n  endTime: string;\r\n  image?: string | null;\r\n  badge?: string | null;\r\n  sellerId?: string | null;\r\n  topBid?: {\r\n    amount: number;\r\n    at: string;\r\n    bidderId: string;\r\n    bidderName?: string | null;\r\n  } | null;\r\n  isEnded: boolean;\r\n  purchasedAt?: string | null;\r\n};\r\n\r\ntype BidRow = {\r\n  id: number;\r\n  amount: number;\r\n  at: string;\r\n  bidderId: string;\r\n  bidderName?: string | null;\r\n};\r\n\r\nexport default function ProductDetailPage() {\r\n  const params = useParams<{ id: string }>();\r\n  const id = Number(params?.id);\r\n  const router = useRouter();\r\n  const { user, loading, refresh } = useSession();\r\n\r\n  const [detail, setDetail] = useState<DetailResp | null>(null);\r\n  const [status, setStatus] = useState<StatusResp | null>(null);\r\n  const [bids, setBids] = useState<BidRow[]>([]);\r\n  const [err, setErr] = useState<string | null>(null);\r\n  const [amount, setAmount] = useState<string>(\"\");\r\n\r\n  const imgSrc = useMemo(() => toImageSrc(detail?.image), [detail?.image]);\r\n\r\n  const loadAll = async () => {\r\n    try {\r\n      const [d, s, bs] = await Promise.all([\r\n        apiFetch<DetailResp>(`/api/auctions/${id}`),\r\n        apiFetch<StatusResp>(`/api/auctions/${id}/status`),\r\n        apiFetch<BidRow[]>(`/api/auctions/${id}/bids`),\r\n      ]);\r\n      setDetail(d);\r\n      setStatus(s);\r\n      setBids(bs);\r\n    } catch (e: any) {\r\n      setErr(e?.message ?? \"Failed to load auction\");\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    void refresh();\r\n  }, [refresh]);\r\n  useEffect(() => {\r\n    if (id) void loadAll();\r\n  }, [id]);\r\n\r\n  // Poll status every 5s (so the leader & button state update)\r\n  useEffect(() => {\r\n    const t = setInterval(() => {\r\n      void apiFetch<StatusResp>(`/api/auctions/${id}/status`)\r\n        .then(setStatus)\r\n        .catch(() => {});\r\n    }, 5000);\r\n    return () => clearInterval(t);\r\n  }, [id]);\r\n\r\n  const currentBid = status?.currentBid ?? detail?.currentBid ?? 0;\r\n  const leaderName =\r\n    status?.topBid?.bidderName ?? detail?.topBid?.bidderName ?? null;\r\n\r\n  const onBid = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setErr(null);\r\n    if (!user) {\r\n      router.push(`/auth/login?next=/productDetail/${id}`);\r\n      return;\r\n    }\r\n    const v = Number(amount);\r\n    if (!Number.isFinite(v) || v <= 0) {\r\n      setErr(\"Enter a valid positive amount.\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      await apiFetch(`/api/auctions/${id}/bids`, {\r\n        method: \"POST\",\r\n        body: JSON.stringify({ Amount: v }),\r\n      });\r\n      setAmount(\"\");\r\n      await loadAll();\r\n    } catch (e: any) {\r\n      setErr(e?.message ?? \"Bid failed\");\r\n    }\r\n  };\r\n\r\n  const onPurchase = async () => {\r\n    setErr(null);\r\n    if (!user) {\r\n      router.push(`/auth/login?next=/productDetail/${id}`);\r\n      return;\r\n    }\r\n    try {\r\n      await apiFetch(`/api/auctions/${id}/purchase`, { method: \"POST\" });\r\n      await loadAll();\r\n      alert(\"Purchase confirmed! (stub)\");\r\n    } catch (e: any) {\r\n      setErr(e?.message ?? \"Purchase failed\");\r\n    }\r\n  };\r\n\r\n  // countdown\r\n  const [now, setNow] = useState(Date.now());\r\n  useEffect(() => {\r\n    const t = setInterval(() => setNow(Date.now()), 1000);\r\n    return () => clearInterval(t);\r\n  }, []);\r\n  const endsAt = detail ? new Date(detail.endTime).getTime() : 0;\r\n  const msLeft = Math.max(0, endsAt - now);\r\n  const isEnded = status?.isEnded ?? msLeft <= 0;\r\n\r\n  const fmtLeft = () => {\r\n    if (!detail) return \"\";\r\n    if (isEnded) return \"Ended\";\r\n    const sec = Math.floor(msLeft / 1000);\r\n    const d = Math.floor(sec / 86400);\r\n    const h = Math.floor((sec % 86400) / 3600);\r\n    const m = Math.floor((sec % 3600) / 60);\r\n    const s = sec % 60;\r\n    const parts = [];\r\n    if (d) parts.push(`${d}d`);\r\n    if (h || d) parts.push(`${h}h`);\r\n    if (m || h || d) parts.push(`${m}m`);\r\n    parts.push(`${s}s`);\r\n    return parts.join(\" \");\r\n    // safe: no String.repeat anywhere :)\r\n  };\r\n\r\n  return (\r\n    <main className=\"max-w-5xl mx-auto p-6\">\r\n      {err && <p className=\"mb-4 text-red-600 break-words\">{err}</p>}\r\n\r\n      {!detail ? (\r\n        <p>Loading…</p>\r\n      ) : (\r\n        <>\r\n          <div className=\"grid md:grid-cols-2 gap-6\">\r\n            <div className=\"rounded overflow-hidden border bg-white\">\r\n              <img\r\n                src={imgSrc}\r\n                alt={detail.title}\r\n                className=\"w-full h-auto object-cover\"\r\n                onError={(e) => {\r\n                  (e.currentTarget as HTMLImageElement).src =\r\n                    \"/placeholder.png\";\r\n                }}\r\n              />\r\n            </div>\r\n            <div>\r\n              <h1 className=\"text-2xl font-bold\">{detail.title}</h1>\r\n              {detail.badge && (\r\n                <span className=\"inline-block mt-2 text-xs px-2 py-0.5 rounded bg-indigo-50 text-indigo-700\">\r\n                  {detail.badge}\r\n                </span>\r\n              )}\r\n\r\n              <p className=\"mt-4 text-gray-700 whitespace-pre-wrap\">\r\n                {detail.description || \"\"}\r\n              </p>\r\n\r\n              <div className=\"mt-6 p-4 rounded-lg border bg-white\">\r\n                <div className=\"text-sm text-gray-600\">Current bid</div>\r\n                <div className=\"text-2xl font-semibold\">\r\n                  LKR {currentBid.toLocaleString()}\r\n                </div>\r\n                <div className=\"mt-1 text-sm text-gray-700\">\r\n                  Leader: {leaderName ? <strong>{leaderName}</strong> : \"—\"}\r\n                </div>\r\n                <div className=\"mt-2 text-sm\">\r\n                  Ends in: <strong>{fmtLeft()}</strong>\r\n                </div>\r\n\r\n                {!isEnded ? (\r\n                  <form onSubmit={onBid} className=\"mt-4 flex gap-2\">\r\n                    <input\r\n                      type=\"number\"\r\n                      min=\"0\"\r\n                      step=\"0.01\"\r\n                      placeholder={`Your bid > ${currentBid.toLocaleString()}`}\r\n                      value={amount}\r\n                      onChange={(e) => setAmount(e.target.value)}\r\n                      className=\"border p-2 rounded w-40\"\r\n                      required\r\n                    />\r\n                    <button\r\n                      className=\"px-4 py-2 rounded bg-indigo-600 text-white\"\r\n                      type=\"submit\"\r\n                    >\r\n                      Place bid\r\n                    </button>\r\n                  </form>\r\n                ) : (\r\n                  <div className=\"mt-4\">\r\n                    {status?.canPurchase ? (\r\n                      <button\r\n                        className=\"px-4 py-2 rounded bg-emerald-600 text-white\"\r\n                        onClick={onPurchase}\r\n                      >\r\n                        Purchase\r\n                      </button>\r\n                    ) : (\r\n                      <p className=\"text-gray-700\">\r\n                        {status?.purchasedAt ? \"Purchased\" : \"Auction ended.\"}\r\n                      </p>\r\n                    )}\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <section className=\"mt-10\">\r\n            <h2 className=\"text-xl font-semibold\">Bids</h2>\r\n            {bids.length === 0 ? (\r\n              <p className=\"mt-3 text-gray-600\">No bids yet.</p>\r\n            ) : (\r\n              <ul className=\"mt-3 divide-y border rounded bg-white\">\r\n                {bids.map((b) => (\r\n                  <li\r\n                    key={b.id}\r\n                    className=\"p-3 flex items-center justify-between\"\r\n                  >\r\n                    <div>\r\n                      <div className=\"font-medium\">\r\n                        LKR {b.amount.toLocaleString()}\r\n                      </div>\r\n                      <div className=\"text-sm text-gray-600\">\r\n                        by {b.bidderName || b.bidderId}\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"text-sm text-gray-500\">\r\n                      {new Date(b.at).toLocaleString()}\r\n                    </div>\r\n                  </li>\r\n                ))}\r\n              </ul>\r\n            )}\r\n          </section>\r\n        </>\r\n      )}\r\n    </main>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}